#!/usr/bin/env node

var request = require('request');
var cheerio = require('cheerio');
var twitter = require('node-twitter');
var url = "http://www.winnipeg.ca/waterandwaste/sewage/service_int.stm";
var twitterRestClient = new twitter.RestClient(process.env.consumer_key, process.env.consumer_secret, process.env.access_token_key, process.env.access_token_secret);


request(url, function(err, resp, body) {
    var $ = cheerio.load(body);
    var poopDate = $('table[class=altShade] tr:nth-child(2) td:nth-child(1)');
    var poopLocation = $('table[class=altShade] tr:nth-child(2) td:nth-child(2)');
    var poopAmount = $('table[class=altShade] tr:nth-child(2) td:nth-child(3)');
    var poopDuration = $('table[class=altShade] tr:nth-child(2) td:nth-child(4)');
    var poopCause = $('table[class=altShade] tr:nth-child(2) td:nth-child(5)');
    var updateDate = $('div [id=lastUpdateDate]');


    //Get current year
    var dateToday = new Date();
    var thisYear = dateToday.getFullYear();


    //and the page update date
    var UpdateDateText = updateDate.text();//get date as text
    var parseUpdateDate = new Date(UpdateDateText); // parse date

    //let's deal with the date the last dump took place
    var poopDateText = poopDate.text() + ' ' + thisYear;
    var dateParse = new Date(poopDateText);


    //location and amount, cause, duration
    var poopLocationText = poopLocation.text();
    var poopAmountText = poopAmount.text();
    if (poopAmountText === "Unknown") {
      poopAmountText = "an unknown amount";
    }
    var poopDurationText = poopDuration.text();
    var poopCauseText = poopCause.text();

    var gifs = ['gifs/gif_1.gif', 'gifs/gif_2.gif', 'gifs/gif_3.gif', 'gifs/gif_4.gif', 'gifs/gif_5.gif', 'gifs/gif_6.gif', 'gifs/gif_7.gif'];
    var gif = gifs[Math.floor(Math.random() * gifs.length)];
    


    var twitterText = 'On ' + poopDateText + ', ' + poopAmountText + ' of sewage was released at ' + poopLocationText + ' #wfp';


  if (dateToday.toDateString() === parseUpdateDate.toDateString()) {
     twitterRestClient.statusesUpdateWithMedia({
            'status': twitterText,
            'media[]': gif
        }, function(error, result) {
            if (error) {
                console.log('Error: ' + (error.code ? error.code + ' ' + error.message : error.message));
            }
            if (result) {
                console.log(result);
            }
        });
  console.log(twitterText);
 } else {
 
console.log('No new incidents.')

 }


  });
